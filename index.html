<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tshirt222</title>
<style>
  /* Styl dla model-viewer z proporcjami 16:9 */
  model-viewer {
    width: 100vw; /* 100% szerokości okna */
    height: 100vh; /* 100% wysokości okna przeglądarki */
    display: block;
  }

  /* Usuń marginesy i przewijanie strony */
  body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
</style>
</head>
<body>

<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
<script async src="https://ga.jspm.io/npm:es-module-shims@1.7.1/dist/es-module-shims.js"></script> 
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@^0.170.0/build/three.module.min.js"
  }
}
</script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer/dist/model-viewer-module.min.js"></script>  
<script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer-effects/dist/model-viewer-effects.min.js"></script> 

<model-viewer id="helmet" disable-tap camera-controls shadow-intensity="2" 
  skybox-image="../../assets/atmosphere.jpg" 
  min-camera-orbit="auto 45deg auto"
  max-camera-orbit="auto 90deg auto" 
  alt="tshirt" 
  src="../../assets/models/tshirt.glb" 
  ar 
  environment-image="../../assets/hdr.hdr" 
  poster="../../assets/LOADING.png" 
  xr-environment>
  <div class="controls">
    <div>
      <p>Diffuse</p>
      <select id="diffuse">
        <option value="../../assets/models/tshirt.png">tshirt1</option>
        <option value="../../assets/models/tshirt1.png">tshirt2</option>
      </select>
    </div>      
  </div>
</model-viewer>

<script type="module">
import * as THREE from 'three';

const modelViewer = document.querySelector("model-viewer#helmet");

if (modelViewer) {
  modelViewer.addEventListener("load", () => {
    const scene = modelViewer.scene; // Access the 3D scene
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    const material = modelViewer.model.materials[0];

    // Function to create and apply textures from dropdown
    const createAndApplyTexture = async (channel, event) => {
      const texture = await modelViewer.createTexture(event.target.value);
      if (channel.includes('base') || channel.includes('metallic')) {
        material.pbrMetallicRoughness[channel].setTexture(texture);
      } else {
        material[channel].setTexture(texture);
      }
    };

    // Add event listener for dropdown texture changes
    document.querySelector('#diffuse').addEventListener('input', (event) => {
      createAndApplyTexture('baseColorTexture', event);
    });

    // Add click event listener for placing decals
    modelViewer.addEventListener('click', (event) => {
      // Convert mouse position to normalized device coordinates
      const rect = modelViewer.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      // Set up the raycaster
      raycaster.setFromCamera(mouse, scene.getCamera());

      // Check for intersections
      const intersects = raycaster.intersectObject(scene, true);
      if (intersects.length > 0) {
        const intersect = intersects[0];
        const point = intersect.point; // Intersection point

        // Create a decal or texture at the intersection point
        const decalTexture = new THREE.TextureLoader().load('../../assets/backgroundAR.png'); // Replace with your decal texture
        const decalMaterial = new THREE.MeshBasicMaterial({ map: decalTexture, transparent: true });
        const decalGeometry = new THREE.PlaneGeometry(0.1, 0.1); // Adjust size as needed
        const decal = new THREE.Mesh(decalGeometry, decalMaterial);

        // Position the decal at the intersection point
        decal.position.copy(point);
        decal.lookAt(intersect.face.normal.clone().add(point)); // Align with the surface normal
        scene.add(decal);
      }
    });
  });
} else {
  console.error("model-viewer element not found");
}
</script>
</body>
</html>